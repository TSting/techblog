<!doctype html><html><head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel="shortcut icon" href=https://www.thefever.dev/favicon.ico>
<link rel=stylesheet href=/css/style.min.css>
<title>Newspeak and Domain Modeling</title></head><body><header id=banner>
<h2><a href=https://www.thefever.dev>thefever.dev</a></h2><nav>
<ul>
</ul></nav></header><main id=content>
<article>
<header id=post-header>
<h1>Newspeak and Domain Modeling</h1><div>
<time>March 1, 2022</time>
</div></header><p><em>this article was first published at <a href=https://www.kkreuning.nl>www.kkreuning.nl</a></em></p><p>Newspeak is a fictional language spoken by the people of Oceania in George Orwell&rsquo;s novel Nineteen Eighty-Four.</p><blockquote>
<p>“‘Don’t you see that the whole aim of Newspeak is to narrow the range of thought? In the end we shall make thoughtcrime literally impossible, because there will be no words in which to express it.’”</p></blockquote><ul>
<li>Syme, from &ldquo;Nineteen Eighty-Four&rdquo; by George Orwell</li></ul><p>Newspeak sucks for the people of Oceania but we developers can learn a thing or two from Ingsoc.</p><h2 id=what-about-domain-primitives>What about domain primitives</h2><p>As an illustration let us come up with a simple example method signature in Java:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>String <span style=color:#a6e22e>foo</span><span style=color:#f92672>(</span>String str<span style=color:#f92672>);</span>
</span></span></code></pre></div><p>What does this code do? The signature only tells us it’s a method from <code>String</code> to <code>String</code> so clearly it does something with the input string, or it might not be able to do something and return <code>null</code>, or mutate some state, or perform other side effects, or throw a <code>Throwable</code> (this is Java after all).</p><p>Now let us take a look at an equivalent signature, in Scala this time:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>sealed</span> <span style=color:#66d9ef>trait</span> <span style=color:#a6e22e>PostalCode</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Zipcode</span><span style=color:#f92672>(</span>i<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Int</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>PostalCode</span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Postleitzahl</span><span style=color:#f92672>(</span>i<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Int</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>PostalCode</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> foo<span style=color:#f92672>(</span>str<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>String</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Option</span><span style=color:#f92672>[</span><span style=color:#66d9ef>PostalCode</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><p>Better, this code turns a <code>String</code> into one of two possible <code>PostalCodes</code> (either US or German) or fails to do so, returning a <code>None</code>. An estimated guess would be that this function tries to create a valid postal code from a string. We just had to specify our domain with a few types and now the intent of this piece of code is clear.</p><p>Borrowing a term from Domain Driven Design, we call domain stuff as a dedicated to construct a <strong>domain primitive</strong>. In the way that a language primitive (<code>String</code>, <code>boolean</code>, <code>int</code>, <code>float</code>, etc.) is a building block of programming code, a domain primitive is a building block for the domain model and business logic (<code>ShoppingBag</code>, <code>Order</code>, <code>Quantity</code>, etc. if you’re in e-commerce for example).</p><p>A domain primitive is precise in its definition and impossible to be illegal, its existence implies its validity.</p><p>The true power of modeling in this way is revealed when using these domain primitives in the actual business logic:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>def</span> x<span style=color:#f92672>(</span>p<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>PostalCode</span><span style=color:#f92672>,</span> n<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>HouseNumber</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Future</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Option</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Address</span><span style=color:#f92672>]]</span>
</span></span></code></pre></div><p>Looking at types, there is only one thing this code could be doing: asynchronously returning an address or no result based on a postal code and a house number. This functional will work with any <code>PostalCode</code> so we can infer that both US and German addresses are supported per our domain.
Good luck figuring all of that out from the following signature:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>CompletionStage<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>x</span><span style=color:#f92672>(</span>String s<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> i<span style=color:#f92672>);</span>
</span></span></code></pre></div><p>Lets see if proper naming might help:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>CompletionStage<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>lookupAddress</span><span style=color:#f92672>(</span>String postalCode<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> houseNumber<span style=color:#f92672>);</span>
</span></span></code></pre></div><p>We are still not sure what valid a postal code even is (US, German, French, etc.) and the house number can still be zero or negative. Also what happens when non-sensical parameters are passed? Do we return <code>null</code> or let the <code>CompletionStage</code> fail? Both are not ideal.</p><h2 id=language-primitives-and-bomb-disposal>Language primitives and bomb disposal</h2><p>Let us investigate the potential problems of using language primitives in domain logic with another example, in which we model a method to transfer money from one account to another account:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>transfer</span><span style=color:#f92672>(</span>String fromAccountNumber<span style=color:#f92672>,</span> String toAccountNumber<span style=color:#f92672>,</span> BigDecimal amount<span style=color:#f92672>);</span>
</span></span></code></pre></div><p>Now let’s count the ways in which this method can be called incorrectly:</p><ol>
<li>any argument could be <code>null</code>.</li><li><code>amount</code> can be zero, which doesn’t make sense when transferring money.</li><li><code>amount</code> can be negative, which also doesn’t make sense.</li><li><code>fromAccountNumber</code> or <code>toAccountNumber</code> might not be actual account numbers.</li><li><code>fromAccountNumber</code> and <code>toAccountNumber</code> can be the same account number, which again doesn’t make sense.</li><li><code>fromAccountNumber</code> and <code>toAccountNumber</code> can be mixed up, transferring money in the wrong direction.</li></ol><p>That’s 9 potential mistakes for this one method and the compiler won’t help us with any of them, it comes down to human disciple and diligence to do the right thing.</p><blockquote>
<p>Issues 1, 2, 3, 4, and 5 can be caught if we add the proper checks ourselves, that way this method will just blow up at runtime, which is unfortunate but whatever. Issue 6 however cannot be checked at all. If the caller mixes up the two account numbers we won’t find out until angry customers start calling!</p></blockquote><h1 id=type-aliases>Type aliases</h1><p>In contrast, consider the following Scala code using the excellent <a href=https://github.com/estatico/scala-newtype>scala-newtype</a> library:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#a6e22e>@newtype</span> <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FromAccount</span><span style=color:#f92672>(</span>a<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Account</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@newtype</span> <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ToAccount</span><span style=color:#f92672>(</span>a<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Account</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> transfer<span style=color:#f92672>(</span>from<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>FromAccount</span><span style=color:#f92672>,</span> to<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>ToAccount</span><span style=color:#f92672>,</span> amount<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Money</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Boolean</span>
</span></span></code></pre></div><p>We added extra type information, like before, and now if the caller mixes up the arguments our code won’t compile. We moved all the way up the defect hierarchy, nice!</p><blockquote>
<p>It is still possible to mix up <code>FromAccount</code> and <code>ToAccount</code> in the example above, but at least that will be more obvious now.
We won’t go into it deeper but if we <em>really</em> want to constrain the code all the way up to 11, we can use something like <a href=https://www.archunit.org>ArchUnit</a> to enforce that a <code>FromAccount</code> can only be derived from the logged in user, ensuring its impossible to create otherwise.</p></blockquote><p>The code above is more verbose but who cares? The code is type safe and its intent is more explicit.</p><p>A lot of modern, high level languages support some notion of type aliasing and/or newtypes:</p><ul>
<li>Scala 2 (as mentioned) has <a href=https://github.com/estatico/scala-newtype>scala-newtype</a></li><li>Scala 3 has <a href=http://dotty.epfl.ch/docs/reference/other-new-features/opaques.html>Opaque Type Aliases</a></li><li>Haxe supports <a href=https://haxe.org/blog/abstracting-primitives/>Abstracting Primitives</a></li><li>Haskell has <a href=https://wiki.haskell.org/Newtype>newtype</a> built in</li><li>Kotlin has <a href=https://kotlinlang.org/docs/type-aliases.html>Type aliases</a></li><li>Swift supports <a href=https://docs.swift.org/swift-book/ReferenceManual/Declarations.html#grammar_typealias-declaration>Type Alias Declaration</a></li><li>OCaml has <a href=https://ocaml.org/learn/tutorials/data_types_and_matching.html>Custom Data Types</a></li></ul><p>Java has&mldr; nothing, so we must create wrappers ourselves.</p><blockquote>
<p>Wrapping in any language as opposed to type aliasing can have an impact on performance because we are basically boxing and unboxing the inner value of the domain primitive. Still the trade-off between performance and type safety is definitely worth it.</p></blockquote><h2 id=how-to-spot-weak-models>How to spot weak models</h2><p>In your current project right now, how many calls to <code>require</code> and <code>assert</code> and their relatives can you count? All of them are like booby traps in the code base and when a caller trips up they will explode all over the runtime.</p><p>Here is an incomplete list of things to watch for that might need some bomb disposal:</p><ul>
<li>checking for <code>null</code>s, absence should be modeled with an <code>Option</code> type.</li><li>functions with two or more arguments of the same type (unless your function is <a href=https://en.m.wikipedia.org/wiki/Commutative_property>commutative</a>).</li><li>using a <code>List</code> where a <code>Set</code> or <code>OrderedSet</code> is more appropriate, which is almost always. Even if you don’t care, a <code>Set</code> communicates intent better.</li><li>language primitives as method inputs for business logic.</li><li><code>UUID</code>s as method argument, a customer uuid is not the same as an order uuid.</li><li>using a <code>List</code> instead of a <code>NonEmptyList</code> when at least one element is expected.</li></ul><h2 id=dealing-with-garbage>Dealing with garbage</h2><p>So far we didn’t had to deal with the external world yet. Real programs have to watch out for garbage data all the time, be it from database responses, user input, third party services, configuration files, etc.</p><p>Let us come up with some JSON response from an API representing a list of users:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>[
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#e6db74>&#34;B4AE6A1B-EE07-4FBE-9588-11F451980A07&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;John&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#f92672>&#34;age&#34;</span>: <span style=color:#ae81ff>32</span>,
</span></span><span style=display:flex><span>	},
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#e6db74>&#34;2711EBA4-098C-44E9-A8A2-518FF07969BF&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;Mary&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#f92672>&#34;age&#34;</span>: <span style=color:#ae81ff>31</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><p>A naive Scala representation of this data and a parse function look like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span><span style=color:#f92672>(</span><span style=color:#66d9ef>val</span> id<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>String</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>val</span> name<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>String</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>val</span> age<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Int</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>object</span> <span style=color:#a6e22e>User</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> fromJson<span style=color:#f92672>(</span>input<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>String</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>List</span><span style=color:#f92672>[</span><span style=color:#66d9ef>User</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> <span style=color:#f92672>???</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>The <code>User</code> object can be decoded from a JSON string and passed to the rest of the program. But what about the unhappy path?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>[
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#960050;background-color:#1e0010>“foo”</span>,
</span></span><span style=display:flex><span>		<span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;John&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#f92672>&#34;age&#34;</span>: <span style=color:#ae81ff>-1</span>,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><p>Is perfectly legal from a type standpoint but domain wise not what we want. If such a response is carelessly passed into our business logic it will become ticking time bomb. A better encoding would be, using <a href=https://github.com/estatico/scala-newtype>scala-newtype</a> and <a href=https://github.com/fthomas/refined>refined</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#a6e22e>@newtype</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserId</span><span style=color:#f92672>(</span>value<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>UUID</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@newtype</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Name</span><span style=color:#f92672>(</span>value<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>String</span> <span style=color:#66d9ef>Refined</span> <span style=color:#66d9ef>NonEmpty</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@newtype</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Age</span><span style=color:#f92672>(</span>value<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Int</span> <span style=color:#66d9ef>Refined</span> <span style=color:#66d9ef>Positive</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#66d9ef>Users</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>NonEmptyList</span><span style=color:#f92672>[</span><span style=color:#66d9ef>User</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span><span style=color:#f92672>(</span>id<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>UserId</span><span style=color:#f92672>,</span> name<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Name</span><span style=color:#f92672>,</span> age<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Age</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>object</span> <span style=color:#a6e22e>User</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> fromJson<span style=color:#f92672>(</span>input<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>String</span><span style=color:#f92672>)</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Either</span><span style=color:#f92672>[</span><span style=color:#66d9ef>DecodeException</span>, <span style=color:#66d9ef>Users</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> <span style=color:#f92672>???</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Now it is <strong>impossible</strong> to create illegal state since we would not be able to satisfy the compiler, illegal state has become inexpressible. We are forced instead to handle invalid input at the most outer layer or “edge” of our program where the raw data comes in.</p><p><strong>tl; dr</strong>: always use domain primitives and never language primitives in your business logic.</p><h2 id=bonus-round>Bonus round</h2><p>We won’t talk about them now, but domain modeling has additional advantages:</p><ul>
<li>reduced cognitive overhead for developers.</li><li>better auto-complete suggestions (where supported by your editor or IDE).</li><li>no ambiguity means less room for bugs which leads to fewer defects.</li><li>reduced API surface decreases the chance of vulnerabilities like SQL injections and XSS.</li></ul><h2 id=conclusion>Conclusion</h2><p>A proper domain model built from domain primitives forces us, developers, to do the right thing.</p><p>In the end we shall make <del>thoughtcrime</del> illegal state literally impossible!</p></article></main><footer id=footer>
</footer></body></html>